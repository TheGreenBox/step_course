\newpage
\subsection{Разработка платы управления}
%\subsubsection{Перечень требований}
\subsubsection{Реализация подсистем}
\paragraph{Вычислительное устройство платы управления}
Критерии выбора:
\begin{itemize}
    \item Быстродействие~--- определяется частотой МП. Максимальная скорость
            вращения привода равна $99\degree \cdot \text{с}^{-1}$. Для самого
            тяжелого с точки зрения процессорного времени алгоритма~---
            ``half step mode'' имеем шаг $0.9\degree$. Тогда частота
            следования импульсов равна $110 ~\text{Гц}$.
            С учетом работы остальной периферии, токового контура и некоторым
            коэффициентом запаса примем частоту работы не менее $32 ~\text{МГц}$
    \item Наличие модуля ШИМ
    \item Наличие АЦП (не менее 10~--~ти разрядов)
    \item Наличие прерываний периферии для организации прерываний по таймеру для
            тактирования импульсов шагового двигателя и реализации работы с
            импульсным датчиком угла
    \item Наличие последовательного интерфейса (UART) для взаимодействия с
            бортовым компьютером
    \item Наличие 32~--~разрядных таймеров для тактирования импульсов
            шагового двигателя
    \item ОЗУ не менее 8 кБ
    \item FLASH~--~память не менее 32 кБ
\end{itemize}

В результате был выбран контролер TMS320--F28035 со следующими параметрами
смотри таблицу (\ref{mcu_params}).
\begin{table}[ht!]
    \centering
    \begin{tabular}{|l|c|}
        \hline
        Характеристика & значение \\
        \hline \hline
        Процессор & TMS320C28x \\
        Архитектура & Гарвардская \\
        Размер машинного слова, бит & 16 \\
        Порядок байт & Little Endian \\
        Языки програмирования & ASM, C, C++ \\
        Частота работы, МГц & 60 \\
        Время выполнения 1 инструкции, нс & 16.67 \\
        \hline
        FLASH, кБ & 64 \\
        SRAM,  кБ & 10 \\
        \hline
        Последовательные интерфейсы: & \\
        SCI  & есть \\
        SPI  & есть \\
        I2C  & есть \\
        LIN  & есть \\
        eCAN & есть \\
        \hline
        Модуль ШИМ (ePWM), шт & 14 \\
        \hline
        Сторожевой таймер & есть \\
        \hline
        АЦП & 12 разрядов \\
        \hline
        Встроенный датчик температуры & есть \\
        \hline
        Периферийные прерывания, шт & 3 \\
        \hline
        GPIO, шт  & 45 \\
        \hline
        Таймеры & 3 32~--~разрядных \\
        \hline
        Корпус & 80~--~ти выводной QFP \\
        \hline
        Напряжение питания, В & 3.3 \\
        \hline
    \end{tabular}
    \caption{Параметры микроконтролера TMS320--F28035}
    \label{mcu_params}
\end{table}


\paragraph{Усилитель мощности}
Усилитель мощности служит для усиления по мощности сигнала управления
двигателем. Он имеет гальваническую развязку всех управляющих сигналов с силовой
частью, что следует учесть при разработке устройства сопряжения с усилителем
мощности.
Был выбран импульсный усилитель мощности со следующими параметрами
(\ref{drv_params}).

\begin{table}[ht!]
    \centering
    \begin{tabular}{|l|c|}
        \hline
        Характеристика & значение \\
        \hline \hline
        Напряжение питания, В & \\
        \rule{2em}{0pt}мин.  & 10.8 \\
        \rule{2em}{0pt}ном.  & 12   \\
        \rule{2em}{0pt}макс. & 13.2 \\
        \hline
        Силовое напряжение, В & \\
        \rule{2em}{0pt}мин.  & 0    \\
        \rule{2em}{0pt}ном.  & 50   \\
        \rule{2em}{0pt}макс. & 52.5 \\
        \hline
        Предельная частота ШИМ, кГц & 500 \\
        \hline
        Максимальный ток, А & \\
        \rule{2em}{0pt}рабочий на канал & 7 \\
        \rule{2em}{0pt}пусковой на канал & 15 \\
        \hline
        Температурный режим, \textcelsius & -40..+85 \\
        \hline
    \end{tabular}
    \caption{Параметры усилителя мощности DRV8412}
    \label{drv_params}
\end{table}

\paragraph{Cвязь с бортовой шиной данных}
Согласно тезническому заданию плата должна управляться со стороны бортовой
\textit{ЭВМ} посредством интерфейса \textit{RS~--~485}, в полудуплексном режиме.
В кабеле используется экранированная витая пара.
Baud rate 115200. Выбран интерфейс \textit{RS~--~422/485 SN75176B} от
\foreignlanguage{english}{Texas~Instruments}.

В качетсве протокола передачи данных использовали модифицированный STX~--~ETX
протокол обмена. Состав сообщения преставлен в таблице (\ref{stx_etx_protocol}).
\begin{table}[ht!]
    \centering
    \begin{tabular}{|c|c|l|}
       \hline
       Тип & Длина, байт & Значение \\ \hline \hline
       STX    & 1      & \texttt{0x02} \\ \hline
       Длина  & 1      & \texttt{0x04..0xFF} \\ \hline
       Адрec  & 1      & \texttt{0x00..0x7F} \\ \hline
       Строка & 0..251 & \texttt{0x00..0x7F} \\ \hline
       ETX    & 1      & \texttt{0x03} \\ \hline
    \end{tabular}
    \caption{Протокол обмена сообщениями с бортовой сетью}
    \label{stx_etx_protocol}
\end{table}

В сообщении содержится идентификатор функции из некоторого предопределённого
набора и некоторое количество операндов нужных этой функции, опционально их
число может быть переменным.
1 сообщение~--- 1 вызов фуншкции.
Все символы в сообщении представляют собой расширенные UTF~--~8 символы
(см. \cite{ISO_IEC_10646_2012} и \cite{rfc3629}). Предельное количество
операндов ограничено только размерами всего сообщения, необходимо уложиться в
251 байт. Предельное число функций в наборе, как и максимальный размер операндов
ограничено размером расширеного UTF-8 символа 6 байт~--- 31 бит
(таблица \ref{max_operand_size}).

\begin{table}
    \centering
    \begin{tabular}{|c|c|}
       \hline
       N байта & Содержимое \\ \hline
       1 & \texttt{b1111110X} \\
       2 & \texttt{b01XXXXXX} \\
       3 & \texttt{b01XXXXXX} \\
       4 & \texttt{b01XXXXXX} \\
       5 & \texttt{b01XXXXXX} \\
       6 & \texttt{b01XXXXXX} \\
       \hline
    \end{tabular}
    \caption{Максимальный размер операнда в сообщении}
    \label{max_operand_size}
\end{table}

\paragraph{Датчик обратной связи}
Выбранный энкодер \textit{ЛИР--137А 6250--05--ПИ} имеет TTL логику, а
микроконтролер имеет логику 0..+3.3. Для преобразования уровней поставили
6~--~разрядный двунаправленный преобразователь нарпяжения,
\foreignlanguage{english}{TXB0106PW~Texas~Instruments}.

\paragraph{Датчик тока и датчик напряжения}
Датчик тока на плате управления выполнен на измерительном резисторе,
последовательно включенном в цепь каждой фазы. Так как управление происходит
сигналом ШИМ, то имеем 4 датчика тока в кажом канале (A, B, C, D).
Сигнал с сериесного резистора, проходящий через RC~--~фильтр и усилили на
операционном усилителе \textit{OPA2350} в инвертирующем подключении.

\paragraph{Шины питания}
Все микросхемы можно разделить на три группы по уровню питающего напряжения:
$$
    \left\{
    \begin{aligned}
        12.0 \text{В} \\
        5.0  \text{В} \\
        3.3  \text{В} \\
    \end{aligned}
    \right.
$$

\begin{table}[ht!]
    \centering
    \begin{tabu}{|X[l,m]|X[-1,c,m]|X[-1,c,m]|X[-1,c,m]|}
        \hline
        Устройство & мин., мА & ном., мА  & макс., мА \\
        \hline \hline
        \textbf{+5В}: &&& \\
        Энкодер \textit{ЛИР~--~137А 6250~--~05~--~ПИ}  & 120 & 120   & 210  \\
        Операционный усилитель \textit{OPA2350} x 2    & 9.9 & 10    & 10.1 \\
        Преобразователь сигнала \textit{TXB0106PW}     & 0   & 0.005 & 0.01 \\
        Интерфейс \textit{RS~--~422/485 SN75176B}      & 8   & 45    & 60   \\
        \hline
        Всего: & 148 & 185 & 291 \\
        \hline
        Регулятор: \textit{
            \foreignlanguage{english}{UA78M05CDCY~Texas~Instruments}
        } & 0 & 300 & 700 \\

        \hline \hline
        \textbf{+3.3В}: &&& \\
        Преобразователь сигнала \textit{TXB0106PW} & 0  & 0.005 & 0.01 \\
        Микроконтролер \textit{TMS320F28035}       & 10 & 108   & 300  \\
        \hline
        Всего: & 10 & 109 & 301 \\
        \hline
        Регулятор: \textit{
            \foreignlanguage{english}{UA78M33CDCY~Texas~Instruments}
        } & 0 & 300 & 700 \\

        \hline \hline
        \textbf{+12В}: &&& \\
        Драйвер ШИМ                               & 10.5 & 21.5 & 35  \\
        Регулятор напряжения \textit{UA78M05CDCY} & 10   & 110  & 500 \\
        Регулятор напряжения \textit{UA78M33CDCY} & 10   & 110  & 500 \\
        \hline
        Всего: & 31 & 242 & 1035 \\
        \hline
        Регулятор: \textit{
            \foreignlanguage{english}{TPS54160DGQ~Texas~Instruments}
        } & 0 & 1500 & 1500 \\

        \hline
    \end{tabu}
    \caption{Потребители на шинах питания платы управления}
    \label{powerConsumersOnBoard}
\end{table}

\paragraph{Индикация состояния}
В числе прочего для целей отладки, тестирования и последущих процедур контроля
необхрдимо иметь визуальное средство для котроля состояния платы.
Перечень <<жизненно важных>> систем платы включает:
шину бортового питания,
шину питаня \textit{12 ~В},
шину питаня \textit{5  ~В},
шину питаня \textit{3.3~В},
бортовая шина передачи информации \textit{RS~--~485},
микроконтролер.

Для этого на плату установлены индикаторы:
\begin{table}[ht!]
    \centering
    \begin{tabular}{|l|c|l|}
        \hline
        Система & цвет & индикатор \\
        \hline
        Статус основной программы & зеленый & \textit{KP--608MGC} \\
        Бортовая сеть связи & голубой & \textit{KPH--1608PBC--A} \\
        Критические ошибоки системы & красный & \textit{KPH--1608SEC} \\
        Напряжение бортового питания & белый & \textit{KPT--1608QWF--E} \\
        Напряжение на шине \textit{+12~В} & желтый & \textit{KPT--1608YD} \\
        Напряжение на шине \textit{+5~В} & зеленый & \textit{KP--1608VGC} \\
        Напряжение на шине \textit{+3.3~В} & оранжевый & \textit{KP--1608VS} \\
        \hline
    \end{tabular}
    \caption{Индикаторы состояния системы}
    \label{boardIndication}
\end{table}

\subsubsection{Принципиальная схема платы упрывления}

\subsubsection{Конструкция платы управления}
\paragraph{Выбор материала заготовки}
В качестве диэлектрика выбрали стеклотекстолит
\textit{СТЕФ~--~У} ГОСТ 12652~--~74 \cite{GOST_12652_74}.
Длительная рабочая температура от \textit{-65\textcelsius}
до \textit{+155\textcelsius}.
Предназначен для работы в условиях нормальной относительной влажности
окружающей среды при напряжении свыше \textit{1000~В}.

\paragraph{Выбор класса точности платы}
Для платы выбран класc точности 3.
Печатные платы 3~--~гo класса~--- наиболее распространенные, поскольку, с одной
стороны, обеспечивают достаточно высокую плотность трассировки и монтажа, а с
другой~--- для их производства требуется рядовое, хотя и специализированное,
оборудование.

\paragraph{Расстояние между элементами проводящего рисунка}
Согласно \cite[табл. 7]{GOST_23751_86} для 3 класса точности, фольгированного
стеклотекстолита:

\begin{tabu}{|X[-1,c,m]|X[l,m]|} \hline
    Мин. расстояние, мм & Проводники \\ \hline
    0.4 & Силовые линии~--- шина внешнего питания \textit{VCC} \\ \hline
    0.2 & Остальные линии, включая внутренние шины питания \\ \hline
\end{tabu}

\paragraph{Толщина печатного проводника}
Согласно \cite[табл. 9]{GOST_23751_86} для 3 класса точности,
фольгированного стеклотекстолита и проводников с покрытием:

\begin{tabu}{|X[-1,c,m]|X[l,m]|} \hline
    Мин. ширина, мм & Проводники \\ \hline
    0.4 & Силовые линии~--- шина внешнего питания \textit{VCC} \\ \hline
    0.2 & Остальные линии, включая внутренние шиниы питания \\ \hline
\end{tabu}

\paragraph{Размеры переходных металлизированых отверстий}
Все металлизированые переходные отверстия на плате, для не монтажных целей:

\begin{itemize}
    \item Диаметр площадки на фольге под отверстия~--- \textit{1.2~мм}
    \item Диаметр металлизированного отверстия~--- \textit{0.7~мм}
    \item Диаметр сверления~--- \textit{0.8~мм}
\end{itemize}

\paragraph{Размеры монтажных металлизированых отверстий}
\begin{itemize}
    \item Диаметр площадки на фольге под отверстия~--- \textit{1.5~мм}
    \item Диаметр металлизированного отверстия~--- \textit{0.9~мм}
    \item Диаметр сверления~--- \textit{1~мм}
\end{itemize}

\paragraph{Размеры присоединительных металлизированых отверстий}
\begin{itemize}
    \item Диаметр площадки на фольге под отверстия~--- \textit{6~мм}
    \item Диаметр металлизированного отверстия~--- \textit{5~мм}
    \item Диаметр сверления~--- \textit{5.2~мм}
\end{itemize}
